---
title: "Assignment 3: Interactive graphics with Gapminder"
author: Camacho Jonathan | Data Visualization | University of Chicago
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
  html_document: js
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(plotly)
library(shiny)
```

```{r}
# Data preparation. 
# Loads baltimore_service_calls.csv file. 
countries_dataset <- as_tibble(read.csv(file = "./data/tidy_countries_dataset.csv", 
                                             stringsAsFactors = FALSE))

# Calculatting population density variable for each observation. 
countries_density <- countries_dataset %>% 
    select(country, continent.x, lifeExp, pop, areaInSqKm) %>%
    mutate(pop_density = (pop / areaInSqKm))

# Creating vector for selectInput tool.
continents_tool_vector <- unique(countries_density$continent.x)
```


Column {.sidebar}
-----------------------------------------------------------------------

```{r}
# Controls
selectInput("continents", label = "Select Country",
            choices = continents_tool_vector, selected = "Americas")

# Set up data download
data_for_dl <- reactive({
  dat <- select(countries_density, country, continent = continent.x, lifeExp, pupulation = pop, areaInSqKm, pop_density)
})

# I could figure out why when rendering using runfile.R, the output object is not found.
# output$downloadCSV <- downloadHandler(
#   filename = 'data.csv',
#   content = function(file) {
#     write_csv(data_for_dl(), file)
#   }
# )
# 
# downloadLink('downloadCSV', label = 'Download CSV for data')

# Select data according to selectInput tool
select_continent <- reactive({
       selected_data <- countries_density[countries_density$continent.x == input$continents, ]
       return(selected_data)
})
```

#### Description

Demographers have pondered for decades the factors that affect populations’ life expectancy. In this brief analysis, I explore the connection between population density and life expectancy. I  expect to find a negative correlation between both variables. To conduct the analysis, I created an API that downloads data from the data set Gapminder; making the analysis fully reproducible. Furthermore, I use the data set Geonames create a tidy data set with conventional country names.


The first plot, “Life Expectancy by Population Density,” does not indicate a clear negative correlation between life expectancy and population density. Contrary, it seems to suggest that as population density increases longevity increases; contrary to the expectations expresses above. Several factors can account for this findings. It is feasible that the expected relationship between population density and life expectancy is not present in the data set that I used. Similarly, life expectancy could be affected by other factors such as access to health care, proper nutrition, and subjective factors such as low levels of stress and high levels of happiness. The second plot, “Country Based Life Expectancy by Population Density” allows the user to select the continent to be plotted. Independently of the continent, the same findings hold along with the same possible explanations. 


Several reasons guided my choice of graphical forms and method for delivery. I chose a scatter plot because the size of the data to be projected in the plot. Similarly, using points and a smooth line to represent data allowed me to show the effect of population density on life expectancy as a position-channel which is one of the most effective mental-visual tasks; allowing readers to extract information more accurately from plots. Furthermore, I modified the alpha parameter for the points to facilitate visualization when points overlap. 


After noticing, in the first plot, the counter-intuitive relationship between pollution density and life expectancy, the question to follow is if the relationship is a global trend or is a regional trend. Thus, adding interactivity to the report allows the user to explore the pattern in different regions such as a continent. This possibility to interact with the data also enhances explorations, attention, and memorization of the findings. I wanted to show the patterns by countries, unfortunately, there are not enough data points in the data set for such visualization; thus, I used the continents.

Column {data-width=350}
-----------------------------------------------------------------------

### Life Expectancy by Population Density 

```{r}
# Generating plot.
all_data <- ggplot(countries_density, aes(pop_density, lifeExp)) +
    geom_point(alpha = .2) +
    geom_smooth() +
    scale_x_log10() +
    labs(x = "Population Density (Millions/Kilometer^2)",
         y = "Life Expectancy") +
       theme_minimal()

renderPlotly({
all_data
})
```

### Country Based Life Expectancy by Population Density
```{r}
# Contry based plot.
renderPlotly({
country_plot <- ggplot(select_continent(), aes(pop_density, lifeExp)) +
    geom_point(alpha = .2) +
    geom_smooth() +
    scale_x_log10() +
    labs(x = "Population Density (Millions/Kilometer^2)",
         y = "Life Expectancy") + 
       theme_minimal()
})
```





